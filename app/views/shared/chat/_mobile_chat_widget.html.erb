<%# 
  Mobile Chat Widget Partial
  
  Optimized for mobile and Hotwire Native apps
  
  Usage:
  <%= render 'shared/chat/mobile_chat_widget', 
      stream: @stream, 
      current_user: current_user,
      platform: platform %>
-%>

<%
  # Get chat room for this stream
  chat_room = stream.chat_room
  
  # Ensure channel is created in GetStream.io
  unless chat_room.channel_id.present?
    chat_room.create_chat_channel!
    chat_room.reload
  end
  
  # Generate user token
  chat_service = Streaming::ChatService.new
  user_token = chat_service.generate_user_token(current_user.id.to_s)
  
  # Upsert user in GetStream.io
  chat_service.upsert_user(current_user)
  
  # Determine if user can moderate
  can_moderate = stream.can_broadcast?(current_user)
  
  # Detect platform
  platform ||= "web"
  is_mobile = request.user_agent =~ /Mobile|Android|iPhone|iPad/
  is_native = request.headers['X-Hotwire-Native'] == 'true' || 
              request.user_agent.include?('BackstagePass')
%>

<div class="mobile-chat-widget <%= is_native ? 'native-app' : 'web-app' %> <%= is_mobile ? 'mobile' : 'desktop' %>"
     data-controller="bridge--chat"
     data-bridge--chat-api-key-value="<%= ENV['GETSTREAM_API_KEY'] %>"
     data-bridge--chat-user-id-value="<%= current_user.id %>"
     data-bridge--chat-user-token-value="<%= user_token %>"
     data-bridge--chat-channel-id-value="<%= chat_room.channel_id %>"
     data-bridge--chat-channel-type-value="livestream"
     data-bridge--chat-user-name-value="<%= current_user.name || current_user.email.split('@').first %>"
     data-bridge--chat-user-image-value="<%= current_user.profile_photo_url if current_user.respond_to?(:profile_photo_url) %>"
     data-bridge--chat-can-moderate-value="<%= can_moderate %>"
     data-bridge--chat-platform-value="<%= platform %>">

  <!-- Native App: Minimal UI (native chat takes over) -->
  <% if is_native %>
    <div class="native-chat-placeholder">
      <div class="flex items-center justify-center p-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
        <div class="text-center">
          <div class="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
              </path>
            </svg>
          </div>
          <h3 class="font-medium text-gray-900 mb-2">Native Chat Loading</h3>
          <p class="text-sm text-gray-600">Chat will open in native interface</p>
          <div class="chat-status text-sm text-yellow-600 mt-2">Initializing...</div>
        </div>
      </div>
      
      <!-- Fallback chat (hidden by default, shown if native fails) -->
      <div class="fallback-chat hidden">
        <%= render 'shared/chat/mobile_chat_interface', 
            chat_room: chat_room, 
            current_user: current_user,
            can_moderate: can_moderate %>
      </div>
    </div>

  <!-- Web/Mobile Browser: Full chat interface -->
  <% else %>
    <%= render 'shared/chat/mobile_chat_interface', 
        chat_room: chat_room, 
        current_user: current_user,
        can_moderate: can_moderate %>
  <% end %>
</div>

<!-- Mobile-specific styles -->
<style>
  .mobile-chat-widget {
    /* Optimize for mobile touch */
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  
  .mobile-chat-widget.native-app .fallback-chat {
    display: none;
  }
  
  .mobile-chat-widget.native-app.chat-error .native-chat-placeholder {
    display: none;
  }
  
  .mobile-chat-widget.native-app.chat-error .fallback-chat {
    display: block;
  }
  
  /* Mobile optimizations */
  @media (max-width: 768px) {
    .mobile-chat-widget {
      /* Full width on mobile */
      width: 100%;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }
    
    .chat-messages {
      /* Optimize scroll for mobile */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    .chat-input input {
      /* Larger touch targets */
      min-height: 44px;
      font-size: 16px; /* Prevent zoom on iOS */
    }
    
    .chat-input button {
      min-width: 44px;
      min-height: 44px;
    }
  }
  
  /* Native app optimizations */
  .mobile-chat-widget.native-app {
    /* Blend with native UI */
    background: transparent;
    border: none;
    box-shadow: none;
  }
</style>