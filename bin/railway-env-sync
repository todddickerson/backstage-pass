#!/bin/bash

echo "üöÇ Railway Environment Variable Sync"
echo "====================================="

# Function to extract YAML values
get_yaml_value() {
    local key=$1
    grep "^${key}:" "config/application.yml" | cut -d' ' -f2- | tr -d '"' | head -1
}

echo ""
echo "üìù Reading from config/application.yml..."

# Extract all values from application.yml
GETSTREAM_APP_ID=$(get_yaml_value "GETSTREAM_APP_ID")
GETSTREAM_API_KEY=$(get_yaml_value "GETSTREAM_API_KEY")
GETSTREAM_API_SECRET=$(get_yaml_value "GETSTREAM_API_SECRET")

STRIPE_CONNECT_CLIENT_ID=$(get_yaml_value "STRIPE_CONNECT_CLIENT_ID")
STRIPE_PUBLISHABLE_KEY=$(get_yaml_value "STRIPE_PUBLISHABLE_KEY")
STRIPE_SECRET_KEY=$(get_yaml_value "STRIPE_SECRET_KEY")

LIVEKIT_PROJECT_ID=$(get_yaml_value "LIVEKIT_PROJECT_ID")
LIVEKIT_SIP_URI=$(get_yaml_value "LIVEKIT_SIP_URI")
LIVEKIT_URL=$(get_yaml_value "LIVEKIT_URL")
LIVEKIT_API_KEY=$(get_yaml_value "LIVEKIT_API_KEY")
LIVEKIT_API_SECRET=$(get_yaml_value "LIVEKIT_API_SECRET")

MUX_TOKEN_ID=$(get_yaml_value "MUX_TOKEN_ID")
MUX_TOKEN_SECRET=$(get_yaml_value "MUX_TOKEN_SECRET")

echo "üîó Setting GetStream variables..."
railway variables \
  --set "GETSTREAM_APP_ID=${GETSTREAM_APP_ID}" \
  --set "GETSTREAM_API_KEY=${GETSTREAM_API_KEY}" \
  --set "GETSTREAM_API_SECRET=${GETSTREAM_API_SECRET}"

echo "üí≥ Setting Stripe variables..."
railway variables \
  --set "STRIPE_CONNECT_CLIENT_ID=${STRIPE_CONNECT_CLIENT_ID}" \
  --set "STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}" \
  --set "STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}"

echo "üìπ Setting LiveKit variables..."
railway variables \
  --set "LIVEKIT_PROJECT_ID=${LIVEKIT_PROJECT_ID}" \
  --set "LIVEKIT_SIP_URI=${LIVEKIT_SIP_URI}" \
  --set "LIVEKIT_URL=${LIVEKIT_URL}" \
  --set "LIVEKIT_API_KEY=${LIVEKIT_API_KEY}" \
  --set "LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}"

echo "üé• Setting Mux variables..."
railway variables \
  --set "MUX_TOKEN_ID=${MUX_TOKEN_ID}" \
  --set "MUX_TOKEN_SECRET=${MUX_TOKEN_SECRET}"

echo "‚öôÔ∏è Setting additional Rails variables..."
railway variables \
  --set "RAILS_LOG_TO_STDOUT=enabled" \
  --set "RAILS_SERVE_STATIC_FILES=enabled" \
  --set "RAILS_MAX_THREADS=5" \
  --set "WEB_CONCURRENCY=2" \
  --set "BUNDLE_WITHOUT=development:test"

echo ""
echo "‚úÖ All environment variables set!"
echo "üöÄ Triggering deployment..."
railway up --detach

echo ""
echo "üìä Current variables:"
railway variables --kv