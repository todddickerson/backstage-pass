#!/usr/bin/env bash

# Sync variables from application.yml to Railway
# Usage: bin/railway-sync-vars

set -e

echo "ðŸ”„ Syncing variables from application.yml to Railway"
echo "================================================"

# Color codes
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if railway CLI is available
if ! command -v railway &> /dev/null; then
  echo -e "${YELLOW}âš ï¸  Railway CLI not installed. Run: npm install -g @railway/cli${NC}"
  exit 1
fi

# Check if logged in
if ! railway whoami &>/dev/null; then
  echo -e "${YELLOW}ðŸ”‘ Please login first: railway login${NC}"
  exit 1
fi

# Function to read YAML values
get_yaml_value() {
  local key=$1
  local file="config/application.yml"
  
  if [ -f "$file" ]; then
    grep "^${key}:" "$file" | cut -d' ' -f2- | tr -d '"' | tr -d "'"
  fi
}

# Function to set Railway variable
sync_var() {
  local key=$1
  local value=$2
  
  if [ -n "$value" ] && [ "$value" != "" ]; then
    echo "  âœ“ $key"
    railway variables set "$key=$value" 2>/dev/null || echo "    âš ï¸ Failed to set $key"
  fi
}

echo -e "${BLUE}ðŸ“ Reading from config/application.yml...${NC}"

# Sync all variables from application.yml
sync_var "GETSTREAM_APP_ID" "$(get_yaml_value 'GETSTREAM_APP_ID')"
sync_var "GETSTREAM_API_KEY" "$(get_yaml_value 'GETSTREAM_API_KEY')"
sync_var "GETSTREAM_API_SECRET" "$(get_yaml_value 'GETSTREAM_API_SECRET')"

sync_var "STRIPE_CONNECT_CLIENT_ID" "$(get_yaml_value 'STRIPE_CONNECT_CLIENT_ID')"
sync_var "STRIPE_PUBLISHABLE_KEY" "$(get_yaml_value 'STRIPE_PUBLISHABLE_KEY')"
sync_var "STRIPE_SECRET_KEY" "$(get_yaml_value 'STRIPE_SECRET_KEY')"

sync_var "LIVEKIT_PROJECT_ID" "$(get_yaml_value 'LIVEKIT_PROJECT_ID')"
sync_var "LIVEKIT_SIP_URI" "$(get_yaml_value 'LIVEKIT_SIP_URI')"
LIVEKIT_URL=$(get_yaml_value 'LIVEKIT_URL')
sync_var "LIVEKIT_URL" "$LIVEKIT_URL"
sync_var "LIVEKIT_HOST" "$LIVEKIT_URL"
sync_var "LIVEKIT_API_KEY" "$(get_yaml_value 'LIVEKIT_API_KEY')"
sync_var "LIVEKIT_API_SECRET" "$(get_yaml_value 'LIVEKIT_API_SECRET')"

sync_var "MUX_TOKEN_ID" "$(get_yaml_value 'MUX_TOKEN_ID')"
sync_var "MUX_TOKEN_SECRET" "$(get_yaml_value 'MUX_TOKEN_SECRET')"

# Update Rails master key if it exists
if [ -f "config/master.key" ]; then
  echo "  âœ“ RAILS_MASTER_KEY (from config/master.key)"
  RAILS_MASTER_KEY=$(cat config/master.key)
  railway variables set "RAILS_MASTER_KEY=$RAILS_MASTER_KEY" 2>/dev/null
fi

echo -e "${GREEN}âœ… Variables synced!${NC}"
echo ""
echo "ðŸš€ Deploy changes? (y/n)"
read -r response
if [[ "$response" =~ ^[Yy]$ ]]; then
  railway up
fi