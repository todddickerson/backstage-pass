#!/usr/bin/env ruby

# Setup git hooks for the project
# Usage: ./bin/setup-git-hooks

require 'fileutils'
require 'colorize'

puts "ğŸ”§ Setting up git hooks...".cyan

# Pre-commit hook content
pre_commit_content = <<~HOOK
#!/bin/sh
# Pre-commit hook to enforce one-PR-at-a-time workflow

echo "ğŸ” Running preflight checks..."

# Run our custom preflight check
./bin/preflight-check
exit_code=$?

case $exit_code in
  0)
    echo "âœ… Preflight passed - proceeding with commit"
    ;;
  1)
    echo "âŒ Preflight failed - commit blocked"
    echo "ğŸ’¡ Fix errors and try again"
    exit 1
    ;;
  2)
    echo "âš ï¸  Preflight warnings detected"
    echo "ğŸ’¡ Consider resolving warnings before commit"
    echo "ğŸ”„ Continuing with commit..."
    ;;
esac

# Run StandardRB if available
if command -v bundle >/dev/null 2>&1 && bundle exec standardrb --version >/dev/null 2>&1; then
  echo "ğŸ” Running StandardRB checks..."
  bundle exec standardrb --fix
  if [ $? -ne 0 ]; then
    echo "âŒ StandardRB issues found - please fix and try again"
    exit 1
  fi
  echo "âœ… StandardRB passed"
fi

echo "âœ… Pre-commit checks complete"
HOOK

# Create .git/hooks directory if it doesn't exist
FileUtils.mkdir_p('.git/hooks')

# Write pre-commit hook
File.write('.git/hooks/pre-commit', pre_commit_content)
FileUtils.chmod(0755, '.git/hooks/pre-commit')
puts "âœ… Created pre-commit hook".green

puts "âœ… Git hooks setup complete!".green
puts
puts "The following hooks were installed:".cyan
puts "  â€¢ pre-commit: Runs preflight checks and StandardRB".light_blue
puts
puts "To disable hooks temporarily, use:".yellow
puts "  git commit --no-verify".light_yellow